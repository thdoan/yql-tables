/*!
 * Modified by T. H. Doan
 * Source: https://github.com/css2xpath/css2xpath/blob/master/index.js
 */
function prependAxis(n,t){return n.replace(regex_first_axis,function(n,i,r){return r.substr(r.length-2)==="::"?n:(r.charAt(0)==="["&&(t+="*"),i+t+r)})}function selectorStart(n,t){for(var i=0,r=0;t--;)switch(n.charAt(t)){case" ":case escape_parens:r++;break;case"[":case"(":if(i--,i<0)return++t+r;break;case"]":case")":i++;break;case",":case"|":if(i===0)return++t+r;default:r=0}return 0}function isNumeric(n){var t=parseInt(n,10);return!isNaN(t)&&""+t===n}function escapeChar(n,t,i,r){var u=0;return n.replace(new RegExp("[\\"+t+"\\"+i+"]","g"),function(n){return n===t&&u++,n===t?n+repeat(r,u):repeat(r,u--)+n})}function repeat(n,t){t=Number(t);for(var i="";;){if(t&1&&(i+=n),t>>>=1,t<=0)break;n+=n}return i}function css2xpath(n,t){var r,i,u;if(t===!0)return n=n.replace(css_pseudo_classes_regex,css_pseudo_classes_callback),n.replace(css_ids_classes_regex,css_ids_classes_callback);for(n=escapeChar(n,"(",")",escape_parens),r=[],n=n.replace(regex_string_literal,function(n,t){if(t.charAt(0)==="="){if(t=t.substr(1).trim(),isNumeric(t))return n}else t=t.substr(1,t.length-2);return repeat(escape_literal,r.push(t))}),n=n.replace(css_combinators_regex,css_combinators_callback),n=n.replace(css_attributes_regex,css_attributes_callback);;){if(i=n.search(regex_css_wrap_pseudo),i===-1)break;i=n.indexOf(":",i);u=selectorStart(n,i);n=n.substr(0,u)+"("+n.substring(u,i)+")"+n.substr(i)}return n=n.replace(css_pseudo_classes_regex,css_pseudo_classes_callback),n=n.replace(css_ids_classes_regex,css_ids_classes_callback),n=n.replace(regex_escaped_literal,function(n,t){var i=r[t.length-1];return'"'+i+'"'}),n=n.replace(regex_specal_chars,""),n=n.replace(regex_filter_prefix,"$1*["),n=n.replace(regex_attr_prefix,"$1/@"),prependAxis(n,"//")}var xpath_to_lower=function(n){return"translate("+(n||"normalize-space()")+", 'ABCDEFGHJIKLMNOPQRSTUVWXYZ', 'abcdefghjiklmnopqrstuvwxyz')"},xpath_ends_with=function(n,t){return"substring("+n+",string-length("+n+")-string-length("+t+")+1)="+t},xpath_url=function(n){return"substring-before(concat(substring-after("+(n||xpath_url_attrs)+',"://"),"?"),"?")'},xpath_url_path=function(n){return"substring-after("+(n||xpath_url_attrs)+',"/")'},xpath_url_domain=function(n){return"substring-before(concat(substring-after("+(n||xpath_url_attrs)+',"://"),"/"),"/")'},xpath_url_attrs="@href|@src",xpath_lower_case=xpath_to_lower(),xpath_ns_uri="ancestor-or-self::*[last()]/@url",xpath_ns_path=xpath_url_path(xpath_url(xpath_ns_uri)),xpath_has_protocal="(starts-with("+xpath_url_attrs+',"http://") or starts-with('+xpath_url_attrs+',"https://"))',xpath_is_internal="starts-with("+xpath_url()+","+xpath_url_domain(xpath_ns_uri)+") or "+xpath_ends_with(xpath_url_domain(),xpath_url_domain(xpath_ns_uri)),xpath_is_local="("+xpath_has_protocal+" and starts-with("+xpath_url()+","+xpath_url(xpath_ns_uri)+"))",xpath_is_path="starts-with("+xpath_url_attrs+',"/")',xpath_is_local_path="starts-with("+xpath_url_path()+","+xpath_ns_path+")",xpath_normalize_space="normalize-space()",xpath_internal="[not("+xpath_has_protocal+") or "+xpath_is_internal+"]",xpath_external="["+xpath_has_protocal+" and not("+xpath_is_internal+")]",escape_literal=String.fromCharCode(30),escape_parens=String.fromCharCode(31),regex_string_literal=/("[^"\x1E]*"|'[^'\x1E]*'|=\s*[^\s\]\'\"]+)/g,regex_escaped_literal=/['"]?(\x1E+)['"]?/g,regex_css_wrap_pseudo=/(\x1F\)|[^\)])\:(first|limit|last|gt|lt|eq|nth)([^\-]|$)/,regex_specal_chars=/[\x1C-\x1F]+/g,regex_first_axis=/^([\s\(\x1F]*)(\.?[^\.\/\(]{1,2}[a-z]*:*)/,regex_filter_prefix=/(^|\/|\:)\[/g,regex_attr_prefix=/([^\(\[\/\|\s\x1F])\@/g,regex_nth_equation=/^([-0-9]*)n.*?([0-9]*)$/,css_combinators_regex=/\s*(!?[+>~,^ ])\s*(\.?\/+|[a-z\-]+::)?([a-z\-]+\()?((and\s*|or\s*|mod\s*)?[^+>~,\s'"\]\|\^\$\!\<\=\x1C-\x1F]+)?/g,css_combinators_callback=function(n,t,i,r,u,f,e,o){var h="",s;if(t===" "&&f!==undefined)return n;if(i===undefined){if(r!==undefined&&r!=="node("&&r!=="text("&&r!=="comment(")return;if(u===undefined&&(u=r),isNumeric(u))return n;s=o.charAt(e-1);(s.length===0||s==="("||s==="|"||s===":")&&(h=".")}if(u===undefined)if(e+n.length===o.length)u="*";else return n;switch(t){case" ":return"//"+u;case">":return"/"+u;case"+":return h+"/following-sibling::*[1]/self::"+u;case"~":return h+"/following-sibling::"+u;case",":return i===undefined,i=".//","|"+i+u;case"^":return"/child::*[1]/self::"+u;case"!^":return"/child::*[last()]/self::"+u;case"! ":return"/ancestor-or-self::"+u;case"!>":return"/parent::"+u;case"!+":return"/preceding-sibling::*[1]/self::"+u;case"!~":return"/preceding-sibling::"+u}},css_attributes_regex=/\[([^\@\|\*\=\^\~\$\!\(\/\s\x1C-\x1F]+)\s*(([\|\*\~\^\$\!]?)=?\s*(\x1E+))?\]/g,css_attributes_callback=function(n,t,i,r,u,f,e){var o="",s=e.charAt(f-1);switch(r){case"!":return o+"[not(@"+t+") or @"+t+'!="'+u+'"]';case"$":return o+"[substring(@"+t+",string-length(@"+t+')-(string-length("'+u+'")-1))="'+u+'"]';case"^":return o+"[starts-with(@"+t+',"'+u+'")]';case"~":return o+'[contains(concat(" ",normalize-space(@'+t+')," "),concat(" ","'+u+'"," "))]';case"*":return o+"[contains(@"+t+',"'+u+'")]';case"|":return o+"[@"+t+'="'+u+'" or starts-with(@'+t+',concat("'+u+'","-"))]';default:return i===undefined?t.charAt(t.length-1)==="("||t.search(/^[0-9]+$/)!==-1||t.indexOf(":")!==-1?n:o+"[@"+t+"]":o+"[@"+t+'="'+u+'"]'}},css_pseudo_classes_regex=/:([a-z\-]+)(\((\x1F+)(([^\x1F]+(\3\x1F+)?)*)(\3\)))?/g,css_pseudo_classes_callback=function(n,t,i,r,u,f,e,o,s,h){var c,a,l;if(h.charAt(s-1)===":"&&h.charAt(s-2)!==":")return n;(t==="odd"||t==="even")&&(u=t,t="nth-of-type");switch(t){case"after":return"[count("+css2xpath("preceding::"+u,!0)+") > 0]";case"after-sibling":return"[count("+css2xpath("preceding-sibling::"+u,!0)+") > 0]";case"before":return"[count("+css2xpath("following::"+u,!0)+") > 0]";case"before-sibling":return"[count("+css2xpath("following-sibling::"+u,!0)+") > 0]";case"checked":return"[@selected or @checked]";case"contains":return"[contains("+xpath_normalize_space+","+u+")]";case"icontains":return"[contains("+xpath_lower_case+","+xpath_to_lower(u)+")]";case"empty":return"[not(*) and not(normalize-space())]";case"enabled":case"disabled":return"[@"+t+"]";case"first-child":return"[not(preceding-sibling::*)]";case"first":case"limit":case"first-of-type":return u!==undefined?"[position()<="+u+"]":"[1]";case"gt":return"[position()>"+(parseInt(u,10)+1)+"]";case"lt":return"[position()<"+(parseInt(u,10)+1)+"]";case"last-child":return"[not(following-sibling::*)]";case"only-child":return"[not(preceding-sibling::*) and not(following-sibling::*)]";case"only-of-type":return"[not(preceding-sibling::*[name()=name(self::node())]) and not(following-sibling::*[name()=name(self::node())])]";case"nth-child":if(isNumeric(u))return"[(count(preceding-sibling::*)+1) = "+u+"]";switch(u){case"even":return"[(count(preceding-sibling::*)+1) mod 2=0]";case"odd":return"[(count(preceding-sibling::*)+1) mod 2=1]";default:return c=(u||"0").replace(regex_nth_equation,"$1+$2").split("+"),c[0]=c[0]||"1",c[1]=c[1]||"0","[(count(preceding-sibling::*)+1)>="+c[1]+" and ((count(preceding-sibling::*)+1)-"+c[1]+") mod "+c[0]+"=0]"}case"nth-of-type":if(isNumeric(u))return"["+u+"]";switch(u){case"odd":return"[position() mod 2=1]";case"even":return"[position() mod 2=0 and position()>=0]";default:return c=(u||"0").replace(regex_nth_equation,"$1+$2").split("+"),c[0]=c[0]||"1",c[1]=c[1]||"0","[position()>="+c[1]+" and (position()-"+c[1]+") mod "+c[0]+"=0]"}case"eq":case"nth":return isNumeric(u)?"["+(parseInt(u,10)+1)+"]":"[1]";case"text":return'[@type="text"]';case"istarts-with":return"[starts-with("+xpath_lower_case+","+xpath_to_lower(u)+")]";case"starts-with":return"[starts-with("+xpath_normalize_space+","+u+")]";case"iends-with":return"["+xpath_ends_with(xpath_lower_case,xpath_to_lower(u))+"]";case"ends-with":return"["+xpath_ends_with(xpath_normalize_space,u)+"]";case"has":return l=prependAxis(css2xpath(u,!0),".//"),"[count("+l+") > 0]";case"has-sibling":return l=css2xpath("preceding-sibling::"+u,!0),"[count("+l+") > 0 or count(following-sibling::"+l.substr(19)+") > 0]";case"has-parent":return"[count("+css2xpath("parent::"+u,!0)+") > 0]";case"has-ancestor":return"[count("+css2xpath("ancestor::"+u,!0)+") > 0]";case"last":case"last-of-type":return u!==undefined?"[position()>last()-"+u+"]":"[last()]";case"selected":return'[local-name()="option" and @selected]';case"skip":case"skip-first":return"[position()>"+u+"]";case"skip-last":return u!==undefined?"[last()-position()>="+u+"]":"[position()<last()]";case"root":return"/ancestor::[last()]";case"range":return a=u.split(","),"["+a[0]+"<=position() and position()<="+a[1]+"]";case"input":return'[local-name()="input" or local-name()="button" or local-name()="select" or local-name()="textarea"]';case"internal":return xpath_internal;case"external":return xpath_external;case"http":case"https":case"mailto":case"javascript":return'[starts-with(@href,concat("'+t+'",":"))]';case"domain":return"[(string-length("+xpath_url_domain()+")=0 and contains("+xpath_url_domain(xpath_ns_uri)+","+u+")) or contains("+xpath_url_domain()+","+u+")]";case"path":return"[starts-with("+xpath_url_path()+',substring-after("'+u+'","/"))]';case"not":return l=css2xpath(u,!0),l.charAt(0)==="["&&(l="self::node()"+l),"[not("+l+")]";case"target":return'[starts-with(@href, "#")]';case"root":return"ancestor-or-self::*[last()]";case"lang":return'[@lang="'+u+'"]';case"read-only":case"read-write":return"[@"+t.replace("-","")+"]";case"valid":case"required":case"in-range":case"out-of-range":return"[@"+t+"]";default:return str}},css_ids_classes_regex=/(#|\.)([^\#\@\.\/\(\[\)\]\|\:\s\+\>\<\'\"\x1D-\x1F]+)/g,css_ids_classes_callback=function(n,t,i){var r="";return t==="#"?r+'[@id="'+i+'"]':r+'[contains(concat(" ",normalize-space(@class)," ")," '+i+' ")]'};
